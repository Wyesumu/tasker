{% extends 'layout.html' %}
{% block title %}Active tasks in {{task_list.name}}{% endblock %}
{% block content %}
<div class="row p-1">
  <div class="col-12 col-md-4 order-12 order-md-0 col-xl-3">
    <div class="card-header border">
      <ul class="nav nav-pills card-header-pills">
        <li class="nav-item col-md-9">
          <h4 class="my-1 ml-2">Active tasks in {{task_list.name}}</h4>
        </li>
        <li class="nav-item dropdown ml-auto">
          <button type="button" class="btn" href="#" id="navbarDropdown-1" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <svg id="i-ellipsis-vertical" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
              <circle cx="16" cy="7" r="2" />
              <circle cx="16" cy="16" r="2" />
              <circle cx="16" cy="25" r="2" />
            </svg>
          </button>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown-1">
            <button type="button" class="dropdown-item btn btn-e-blue" data-toggle="modal" data-target="#editListModal">
              Edit list
            </button>
            <button type="button" class="dropdown-item btn btn-e-blue" data-toggle="modal" data-target="#addUserModal">
              Add new user
            </button>
            <button type="button" class="dropdown-item btn btn-e-blue" data-toggle="modal" data-target="#treeViewModal">
              Tree view
            </button>
            <div class="dropdown-divider"></div>
            <form action="/remove_list?{{request.query_string.decode('utf-8')}}" method="POST">
              <input type="submit" class="dropdown-item btn btn-e-red" value="Remove">
            </form>
          </div>
        </li>
      </ul>
    </div>
    <div class="list-group">
    {% if request.path == "/closed" %}
      {% for task in task_list.tasks %}
        {% if not task.parent_task_id and task.closed %}
        <a href="{{url_for('closed', task_id = task.id, list_id = request.args.get('list_id'))}}" class="list-group-item list-group-item-action">
          <div class="d-flex w-100">
            <h5 class="mb-1">{{task.title}}</h5>
          </div>
          <p class="mb-1">
            {{task.details}}
          </p>
        </a>
        {% endif %}
      {% endfor %}
    {% else %}
      {% for task in task_list.tasks %}
        {% if not task.parent_task_id and not task.closed %}
        <a href="{{url_for('index', task_id = task.id, list_id = request.args.get('list_id'))}}" class="list-group-item list-group-item-action">
          <div class="d-flex w-100">
            <h5 class="mb-1">{{task.title}}</h5>
          </div>
          <p class="mb-1">
            {{task.details}}
          </p>
          {% if task.date %}
          <small 
            {% if task.date < task.date.now() %} 
              style='color: red'
            {%endif%}
          >
            <svg id="i-clock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
              <circle cx="16" cy="16" r="14" />
              <path d="M16 8 L16 16 20 20" />
            </svg>
            {{task.date.strftime("%Y-%m-%d %H:%M")}}
          </small>
          {% endif %}
        </a>
        {% endif %}
      {% endfor %}
        <a href="{{url_for('new_task', list_id = request.args.get('list_id'))}}" class="list-group-item list-group-item-action">
          <div class="d-flex w-100">
            <span style="padding-right: 1rem">
              <svg id="i-plus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                <path d="M16 2 L16 30 M2 16 L30 16" />
              </svg>
            </span>
            <h5 class="mb-1">Create new task</h5>
          </div>
        </a>
      {% endif %}
    </div>
  </div>
  {% block task_box %}
  {% endblock %}
</div>

<!-- Modals for TaskList editing -->

<div class="modal fade" id="editListModal" tabindex="-1" role="dialog" aria-labelledby="editListModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Edit task list</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="edit_list?task_list_id={{task_list.id}}" method="POST">
        <div class="modal-body">
          <label>Task list name: </label>
          <input type="text" placeholder="Enter task list name here" class="form-control" value="{{task_list.name}}" name="edit_task_name">
          <label>Users:</label>
          <ul>
            {% for user in task_list.users %}
              <li>
                {{user.username}} <a href="/remove_user?task_list_id={{task_list.id}}&user={{user.id}}">x</a>
              </li>
            {% endfor %}
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" name="task_list_id">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add new user to the {{task_list.name}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="add_user?task_list_id={{task_list.id}}" method="POST">
        <div class="modal-body">
          <label>Username: </label>
          <input type="text" placeholder="Enter username here" class="form-control" name="username">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" name="task_list_id">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% macro iter_loop(task, task_list) -%}
    <ul>
      {% for sub_task in task.sub_task %}
        <li>
          <a href="/?task_id={{sub_task.id}}&list_id={{task_list.id}}">{{sub_task.title}}</a>
          {% if sub_task.sub_task %}
            {{ iter_loop(sub_task, task_list) }}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
{%- endmacro %}

<div class="modal fade" id="treeViewModal" tabindex="-1" role="dialog" aria-labelledby="treeViewModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Tasks in tree view for {{task_list.name}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul>
          {% for task in task_list.tasks %}
            {% if not task.parent_task_id and not task.closed %}
              <li>
                <a href="/?task_id={{task.id}}&list_id={{task_list.id}}">{{task.title}}</a>
                {{ iter_loop(task, task_list) }}
              </li>
            {%endif%}
          {% endfor %}
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}